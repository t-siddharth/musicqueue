<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mindful — Stress Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0e27;
            --bg-card: #151b38;
            --bg-hover: #1a2347;
            --text-primary: #e8e9f3;
            --text-secondary: #9ca3c4;
            --text-tertiary: #6b7399;
            --accent-calm: #4ade80;
            --accent-mild: #fbbf24;
            --accent-moderate: #fb923c;
            --accent-high: #f87171;
            --border: #2a3358;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Pro', serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
        }

        .grain-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            z-index: 9999;
        }

        header {
            padding: 3rem 2rem 2rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(to bottom, var(--bg-dark), transparent);
            animation: fadeIn 0.8s ease-out;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .header-left {
            flex: 1;
            min-width: 200px;
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 300;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-family: 'DM Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .time-selector {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 0.5rem;
        }

        .time-btn {
            font-family: 'DM Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 50px;
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-btn:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .time-btn.active {
            background: var(--accent-calm);
            color: var(--bg-dark);
            font-weight: 500;
        }

        .update-indicator {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-family: 'DM Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .update-indicator.visible {
            opacity: 1;
        }

        .update-indicator.syncing {
            border-color: var(--accent-calm);
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-calm);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        .loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            flex-direction: column;
            gap: 2rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-calm);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-family: 'DM Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
            opacity: 0;
            animation: fadeIn 0.8s ease-out 0.3s forwards;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideUp 0.6s ease-out backwards;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--text-tertiary);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--stat-color), transparent);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-label {
            font-family: 'DM Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-tertiary);
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 600;
            line-height: 1;
            margin-bottom: 0.5rem;
            color: var(--stat-color);
            text-shadow: 0 0 20px var(--stat-glow);
        }

        .stat-subtext {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            animation: slideUp 0.6s ease-out 0.5s backwards;
        }

        .chart-header {
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 0.5rem;
            letter-spacing: -0.01em;
        }

        .chart-description {
            font-family: 'DM Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .error-container {
            background: var(--bg-card);
            border: 1px solid var(--accent-high);
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            max-width: 600px;
            margin: 4rem auto;
        }

        .error-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .error-title {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: var(--accent-high);
        }

        .error-message {
            color: var(--text-secondary);
            line-height: 1.8;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            
            .header-content {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="grain-overlay"></div>
    
    <div id="updateIndicator" class="update-indicator">
        <div class="pulse-dot"></div>
        <span id="updateText">Live Updates Active</span>
    </div>
    
    <header>
        <div class="header-content">
            <div class="header-left">
                <h1>Mindful</h1>
                <div class="subtitle">Stress Analytics Dashboard</div>
            </div>
            <div class="time-selector">
                <button class="time-btn" data-granularity="minute">Minutes</button>
                <button class="time-btn" data-granularity="hour">Hours</button>
                <button class="time-btn active" data-granularity="day">Days</button>
            </div>
        </div>
    </header>

    <div id="loadingContainer" class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">Analyzing Patterns...</div>
    </div>

    <div id="errorContainer" style="display: none;"></div>
    <div id="dashboard" class="dashboard" style="display: none;"></div>

    <script>
        // Global state
        let chartInstances = {
            zones: null,
            hourly: null,
            trend: null,
            variability: null
        };
        let previousDataLength = 0;
        let currentGranularity = 'day';
        let fullData = [];

        // Fetch stress data
        async function fetchStressData() {
            try {
                const response = await fetch('https://mindful-makers-dec-20-25.s3.us-east-2.amazonaws.com/stress_reading.txt');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('data: ', text)
                console.log('Raw data from S3 (first 500 chars):', text.substring(0, 500));
                console.log('Total text length:', text.length);
                
                // Parse new format: "2026-02-14T16:44:04.791408 0.26"
                const lines = text.trim().split(/\r?\n/);
                console.log('Number of lines:', lines.length);
                console.log('First 10 lines:', lines.slice(0, 10));
                
                const dataWithTimestamps = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue; // Skip empty lines
                    
                    const parts = line.split(/\s+/);
                    console.log(`Line ${i}: "${line}" -> Parts:`, parts);
                    
                    if (parts.length >= 2) {
                        const timestamp = new Date(parts[0]);
                        const stress = parseFloat(parts[1]);
                        
                        console.log(`  Timestamp: ${parts[0]} -> ${timestamp} (valid: ${timestamp.toString() !== 'Invalid Date'})`);
                        console.log(`  Stress: ${parts[1]} -> ${stress} (valid: ${!isNaN(stress)})`);
                        
                        if (!isNaN(stress) && timestamp.toString() !== 'Invalid Date') {
                            dataWithTimestamps.push({ timestamp, stress });
                        } else {
                            console.warn(`  Skipped line ${i}: invalid data`);
                        }
                    } else {
                        console.warn(`  Skipped line ${i}: not enough parts (${parts.length})`);
                    }
                    
                    // Only log first 5 lines in detail
                    if (i >= 5) break;
                }
                
                // Parse remaining lines without detailed logging
                for (let i = 5; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const parts = line.split(/\s+/);
                    if (parts.length >= 2) {
                        const timestamp = new Date(parts[0]);
                        const stress = parseFloat(parts[1]);
                        if (!isNaN(stress) && timestamp.toString() !== 'Invalid Date') {
                            dataWithTimestamps.push({ timestamp, stress });
                        }
                    }
                }
                
                console.log('Successfully parsed', dataWithTimestamps.length, 'readings');
                if (dataWithTimestamps.length > 0) {
                    console.log('First reading:', dataWithTimestamps[0]);
                    console.log('Last reading:', dataWithTimestamps[dataWithTimestamps.length - 1]);
                }
                
                return dataWithTimestamps;
            } catch (error) {
                console.error('Error fetching stress data:', error);
                throw error;
            }
        }

        // Calculate statistics based on current granularity
        function calculateStats(data) {
            const stressValues = data.map(d => d.stress);
            
            // Zones
            const zones = {
                calm: stressValues.filter(s => s < 0.25).length,
                mild: stressValues.filter(s => s >= 0.25 && s < 0.5).length,
                moderate: stressValues.filter(s => s >= 0.5 && s < 0.75).length,
                high: stressValues.filter(s => s >= 0.75).length
            };
            
            const totalMinutes = stressValues.length;
            const zonePercentages = {
                calm: (zones.calm / totalMinutes * 100).toFixed(1),
                mild: (zones.mild / totalMinutes * 100).toFixed(1),
                moderate: (zones.moderate / totalMinutes * 100).toFixed(1),
                high: (zones.high / totalMinutes * 100).toFixed(1)
            };

            // Time series based on granularity
            let timeSeriesData;
            
            if (currentGranularity === 'minute') {
                const last120 = data.slice(-120); // Last 2 hours
                timeSeriesData = {
                    labels: last120.map(d => d.timestamp.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })),
                    values: last120.map(d => d.stress),
                    title: 'Last 2 Hours (Per Minute)'
                };
            } else if (currentGranularity === 'hour') {
                const hourlyData = {};
                data.forEach(d => {
                    const hourKey = `${d.timestamp.getMonth()+1}/${d.timestamp.getDate()} ${d.timestamp.getHours()}:00`;
                    if (!hourlyData[hourKey]) {
                        hourlyData[hourKey] = { sum: 0, count: 0, timestamp: d.timestamp };
                    }
                    hourlyData[hourKey].sum += d.stress;
                    hourlyData[hourKey].count++;
                });
                
                const sorted = Object.entries(hourlyData).sort((a, b) => 
                    a[1].timestamp - b[1].timestamp
                );
                
                timeSeriesData = {
                    labels: sorted.map(([key]) => key),
                    values: sorted.map(([, val]) => val.sum / val.count),
                    title: 'Hourly Averages'
                };
            } else {
                const dailyData = {};
                data.forEach(d => {
                    const dateKey = d.timestamp.toDateString();
                    if (!dailyData[dateKey]) {
                        dailyData[dateKey] = { sum: 0, count: 0 };
                    }
                    dailyData[dateKey].sum += d.stress;
                    dailyData[dateKey].count++;
                });
                
                const sorted = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));
                
                timeSeriesData = {
                    labels: sorted.map(d => new Date(d).toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric' 
                    })),
                    values: sorted.map(d => dailyData[d].sum / dailyData[d].count),
                    title: 'Daily Averages'
                };
            }

            // Hour-of-day pattern
            const hourlyStress = Array(24).fill(0).map(() => ({ sum: 0, count: 0 }));
            data.forEach(d => {
                const hour = d.timestamp.getHours();
                hourlyStress[hour].sum += d.stress;
                hourlyStress[hour].count++;
            });
            const hourlyAverages = hourlyStress.map(h => h.count > 0 ? h.sum / h.count : 0);

            // Stress spikes
            const spikes = [];
            let inSpike = false;
            let spikeStart = null;
            
            data.forEach((d, i) => {
                if (d.stress >= 0.7 && !inSpike) {
                    inSpike = true;
                    spikeStart = i;
                } else if (d.stress < 0.7 && inSpike) {
                    spikes.push({
                        duration: i - spikeStart,
                        maxStress: Math.max(...data.slice(spikeStart, i).map(x => x.stress))
                    });
                    inSpike = false;
                }
            });

            const avgSpikeDuration = spikes.length > 0 
                ? spikes.reduce((sum, s) => sum + s.duration, 0) / spikes.length 
                : 0;

            // Variability based on granularity
            let variabilityData;
            
            if (currentGranularity === 'minute') {
                const windowSize = 10;
                const varData = [];
                for (let i = windowSize; i <= data.length; i++) {
                    const window = data.slice(i - windowSize, i);
                    const values = window.map(d => d.stress);
                    const mean = values.reduce((a, b) => a + b, 0) / values.length;
                    const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
                    varData.push({
                        label: window[window.length - 1].timestamp.toLocaleTimeString('en-US', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }),
                        variability: Math.sqrt(variance)
                    });
                }
                variabilityData = varData.slice(-120);
            } else if (currentGranularity === 'hour') {
                const hourlyGroups = {};
                data.forEach(d => {
                    const hourKey = `${d.timestamp.getMonth()+1}/${d.timestamp.getDate()} ${d.timestamp.getHours()}:00`;
                    if (!hourlyGroups[hourKey]) {
                        hourlyGroups[hourKey] = { values: [], timestamp: d.timestamp };
                    }
                    hourlyGroups[hourKey].values.push(d.stress);
                });
                
                variabilityData = Object.entries(hourlyGroups)
                    .sort((a, b) => a[1].timestamp - b[1].timestamp)
                    .map(([hour, data]) => {
                        const mean = data.values.reduce((a, b) => a + b, 0) / data.values.length;
                        const variance = data.values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / data.values.length;
                        return {
                            label: hour,
                            variability: Math.sqrt(variance)
                        };
                    });
            } else {
                const dailyGroups = {};
                data.forEach(d => {
                    const dateKey = d.timestamp.toDateString();
                    if (!dailyGroups[dateKey]) {
                        dailyGroups[dateKey] = [];
                    }
                    dailyGroups[dateKey].push(d.stress);
                });
                
                variabilityData = Object.entries(dailyGroups)
                    .sort((a, b) => new Date(a[0]) - new Date(b[0]))
                    .map(([date, values]) => {
                        const mean = values.reduce((a, b) => a + b, 0) / values.length;
                        const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
                        return {
                            label: new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                            variability: Math.sqrt(variance)
                        };
                    });
            }

            return {
                zones,
                zonePercentages,
                hourlyAverages,
                spikes,
                avgSpikeDuration,
                timeSeriesData,
                variabilityData,
                totalMinutes,
                avgStress: stressValues.reduce((a, b) => a + b, 0) / stressValues.length,
                maxStress: Math.max(...stressValues),
                minStress: Math.min(...stressValues)
            };
        }

        // Update charts
        function updateCharts(stats) {
            if (chartInstances.zones) {
                chartInstances.zones.data.datasets[0].data = [
                    stats.zonePercentages.calm,
                    stats.zonePercentages.mild,
                    stats.zonePercentages.moderate,
                    stats.zonePercentages.high
                ];
                chartInstances.zones.update('active');
            }

            if (chartInstances.hourly) {
                chartInstances.hourly.data.datasets[0].data = stats.hourlyAverages;
                chartInstances.hourly.update('active');
            }

            if (chartInstances.trend) {
                chartInstances.trend.data.labels = stats.timeSeriesData.labels;
                chartInstances.trend.data.datasets[0].data = stats.timeSeriesData.values;
                chartInstances.trend.data.datasets[0].backgroundColor = stats.timeSeriesData.values.map(v => {
                    if (v < 0.25) return 'rgba(74, 222, 128, 0.8)';
                    if (v < 0.5) return 'rgba(251, 191, 36, 0.8)';
                    if (v < 0.75) return 'rgba(251, 146, 60, 0.8)';
                    return 'rgba(248, 113, 113, 0.8)';
                });
                document.querySelector('#trendChart').closest('.chart-container').querySelector('.chart-description').textContent = stats.timeSeriesData.title.toUpperCase();
                chartInstances.trend.update('active');
            }

            if (chartInstances.variability) {
                chartInstances.variability.data.labels = stats.variabilityData.map(d => d.label);
                chartInstances.variability.data.datasets[0].data = stats.variabilityData.map(d => d.variability);
                chartInstances.variability.update('active');
            }
        }

        // Update stats cards
        function updateStatsCards(stats) {
            const dominantZone = Object.entries(stats.zones)
                .reduce((max, [zone, count]) => count > max.count ? { zone, count } : max, { zone: 'calm', count: 0 }).zone;
            
            const zoneColors = {
                calm: 'var(--accent-calm)',
                mild: 'var(--accent-mild)',
                moderate: 'var(--accent-moderate)',
                high: 'var(--accent-high)'
            };

            document.querySelectorAll('.stat-card').forEach((card, index) => {
                const valueEl = card.querySelector('.stat-value');
                const subtextEl = card.querySelector('.stat-subtext');
                
                if (index === 0) {
                    valueEl.textContent = `${(stats.avgStress * 100).toFixed(0)}%`;
                    subtextEl.textContent = `Across ${stats.totalMinutes} minutes tracked`;
                } else if (index === 1) {
                    valueEl.textContent = `${stats.zonePercentages[dominantZone]}%`;
                    subtextEl.textContent = `${dominantZone.charAt(0).toUpperCase() + dominantZone.slice(1)} zone`;
                    card.style.setProperty('--stat-color', zoneColors[dominantZone]);
                } else if (index === 2) {
                    valueEl.textContent = stats.spikes.length;
                    subtextEl.textContent = `Avg duration: ${stats.avgSpikeDuration.toFixed(0)} min`;
                } else if (index === 3) {
                    valueEl.textContent = (stats.totalMinutes / 60).toFixed(1);
                    subtextEl.textContent = 'Hours of data';
                }
            });
        }

        // Render dashboard
        function renderDashboard(data, stats) {
            const dashboard = document.getElementById('dashboard');
            const dominantZone = Object.entries(stats.zones)
                .reduce((max, [zone, count]) => count > max.count ? { zone, count } : max, { zone: 'calm', count: 0 }).zone;
            
            const zoneColors = {
                calm: 'var(--accent-calm)',
                mild: 'var(--accent-mild)',
                moderate: 'var(--accent-moderate)',
                high: 'var(--accent-high)'
            };

            dashboard.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card" style="--stat-color: var(--accent-mild); --stat-glow: rgba(251, 191, 36, 0.2);">
                        <div class="stat-label">Average Stress</div>
                        <div class="stat-value">${(stats.avgStress * 100).toFixed(0)}%</div>
                        <div class="stat-subtext">Across ${stats.totalMinutes} minutes tracked</div>
                    </div>
                    
                    <div class="stat-card" style="--stat-color: ${zoneColors[dominantZone]}; --stat-glow: rgba(74, 222, 128, 0.2);">
                        <div class="stat-label">Most Time Spent</div>
                        <div class="stat-value">${stats.zonePercentages[dominantZone]}%</div>
                        <div class="stat-subtext">${dominantZone.charAt(0).toUpperCase() + dominantZone.slice(1)} zone</div>
                    </div>
                    
                    <div class="stat-card" style="--stat-color: var(--accent-high); --stat-glow: rgba(248, 113, 113, 0.2);">
                        <div class="stat-label">Stress Spikes</div>
                        <div class="stat-value">${stats.spikes.length}</div>
                        <div class="stat-subtext">Avg duration: ${stats.avgSpikeDuration.toFixed(0)} min</div>
                    </div>
                    
                    <div class="stat-card" style="--stat-color: var(--text-primary); --stat-glow: rgba(232, 233, 243, 0.1);">
                        <div class="stat-label">Tracking Period</div>
                        <div class="stat-value">${(stats.totalMinutes / 60).toFixed(1)}</div>
                        <div class="stat-subtext">Hours of data</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Daily Stress Zones</div>
                        <div class="chart-description">Percentage of time in each zone</div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="zonesChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Hourly Stress Pattern</div>
                        <div class="chart-description">Average stress by hour of day</div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Stress Trends</div>
                            <div class="chart-description">${stats.timeSeriesData.title.toUpperCase()}</div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Stress Stability</div>
                            <div class="chart-description">Variability (lower is more stable)</div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="variabilityChart"></canvas>
                        </div>
                    </div>
                </div>
            `;

            createZonesChart(stats);
            createHourlyChart(stats);
            createTrendChart(stats);
            createVariabilityChart(stats);
        }

        function createZonesChart(stats) {
            const ctx = document.getElementById('zonesChart').getContext('2d');
            chartInstances.zones = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Calm (0-25%)', 'Mild (25-50%)', 'Moderate (50-75%)', 'High (75-100%)'],
                    datasets: [{
                        data: [
                            stats.zonePercentages.calm,
                            stats.zonePercentages.mild,
                            stats.zonePercentages.moderate,
                            stats.zonePercentages.high
                        ],
                        backgroundColor: [
                            'rgba(74, 222, 128, 0.8)',
                            'rgba(251, 191, 36, 0.8)',
                            'rgba(251, 146, 60, 0.8)',
                            'rgba(248, 113, 113, 0.8)'
                        ],
                        borderColor: 'var(--bg-dark)',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'var(--text-secondary)',
                                font: { family: 'DM Mono', size: 11 },
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'var(--bg-card)',
                            titleColor: 'var(--text-primary)',
                            bodyColor: 'var(--text-secondary)',
                            borderColor: 'var(--border)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: (context) => `${context.label}: ${context.parsed}%`
                            }
                        }
                    }
                }
            });
        }

        function createHourlyChart(stats) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            const hours = Array.from({ length: 24 }, (_, i) => `${i}:00`);
            
            chartInstances.hourly = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Average Stress',
                        data: stats.hourlyAverages,
                        borderColor: 'rgba(251, 191, 36, 1)',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(251, 191, 36, 1)',
                        pointBorderColor: 'var(--bg-dark)',
                        pointBorderWidth: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                color: 'var(--text-tertiary)',
                                font: { family: 'DM Mono', size: 10 },
                                callback: (value) => `${(value * 100).toFixed(0)}%`
                            },
                            grid: {
                                color: 'var(--border)',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: 'var(--text-tertiary)',
                                font: { family: 'DM Mono', size: 10 },
                                maxRotation: 0
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'var(--bg-card)',
                            titleColor: 'var(--text-primary)',
                            bodyColor: 'var(--text-secondary)',
                            borderColor: 'var(--border)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: (context) => `Stress: ${(context.parsed.y * 100).toFixed(1)}%`
                            }
                        }
                    }
                }
            });
        }

        function createTrendChart(stats) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            chartInstances.trend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stats.timeSeriesData.labels,
                    datasets: [{
                        label: 'Stress Level',
                        data: stats.timeSeriesData.values,
                        backgroundColor: stats.timeSeriesData.values.map(v => {
                            if (v < 0.25) return 'rgba(74, 222, 128, 0.8)';
                            if (v < 0.5) return 'rgba(251, 191, 36, 0.8)';
                            if (v < 0.75) return 'rgba(251, 146, 60, 0.8)';
                            return 'rgba(248, 113, 113, 0.8)';
                        }),
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                color: 'var(--text-tertiary)',
                                font: { family: 'DM Mono', size: 10 },
                                callback: (value) => `${(value * 100).toFixed(0)}%`
                            },
                            grid: {
                                color: 'var(--border)',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: 'var(--text-tertiary)',
                                font: { family: 'DM Mono', size: 10 },
                                maxTicksLimit: 20
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'var(--bg-card)',
                            titleColor: 'var(--text-primary)',
                            bodyColor: 'var(--text-secondary)',
                            borderColor: 'var(--border)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: (context) => `Stress: ${(context.parsed.y * 100).toFixed(1)}%`
                            }
                        }
                    }
                }
            });
        }

        function createVariabilityChart(stats) {
            const ctx = document.getElementById('variabilityChart').getContext('2d');
            
            chartInstances.variability = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: stats.variabilityData.map(d => d.label),
                    datasets: [{
                        label: 'Variability',
                        data: stats.variabilityData.map(d => d.variability),
                        borderColor: 'rgba(139, 92, 246, 1)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(139, 92, 246, 1)',
                        pointBorderColor: 'var(--bg-dark)',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'var(--text-tertiary)',
                                font: { family: 'DM Mono', size: 10 }
                            },
                            grid: {
                                color: 'var(--border)',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: 'var(--text-tertiary)',
                                font: { family: 'DM Mono', size: 10 },
                                maxTicksLimit: 20
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'var(--bg-card)',
                            titleColor: 'var(--text-primary)',
                            bodyColor: 'var(--text-secondary)',
                            borderColor: 'var(--border)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: (context) => `Variability: ${context.parsed.y.toFixed(3)}`
                            }
                        }
                    }
                }
            });
        }

        // Real-time update
        async function updateDashboard() {
            const indicator = document.getElementById('updateIndicator');
            const updateText = document.getElementById('updateText');
            
            try {
                indicator.classList.add('visible', 'syncing');
                updateText.textContent = 'Syncing...';
                
                const data = await fetchStressData();
                
                if (data.length === 0) return;

                if (data.length !== previousDataLength) {
                    const newReadings = data.length - previousDataLength;
                    updateText.textContent = `Updated +${newReadings} readings`;
                    
                    previousDataLength = data.length;
                    fullData = data;
                    
                    const stats = calculateStats(data);
                    updateStatsCards(stats);
                    updateCharts(stats);
                    
                    setTimeout(() => {
                        indicator.classList.remove('syncing');
                        updateText.textContent = 'Live Updates Active';
                    }, 2000);
                } else {
                    indicator.classList.remove('syncing');
                    updateText.textContent = 'Live Updates Active';
                }
            } catch (error) {
                console.error('Error updating dashboard:', error);
                indicator.classList.remove('syncing');
                updateText.textContent = 'Update Failed';
                setTimeout(() => {
                    updateText.textContent = 'Live Updates Active';
                }, 3000);
            }
        }

        function showError(message) {
            document.getElementById('loadingContainer').style.display = 'none';
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = `
                <div class="error-container">
                    <div class="error-icon">⚠️</div>
                    <div class="error-title">Unable to Load Data</div>
                    <div class="error-message">${message}</div>
                </div>
            `;
        }

        // Initialize
        async function init() {
            try {
                const data = await fetchStressData();
                
                console.log('Fetched data:', data.length, 'readings');
                console.log('First reading:', data[0]);
                console.log('Last reading:', data[data.length - 1]);
                
                if (data.length === 0) {
                    throw new Error('No valid stress readings found in the data file.');
                }
                
                previousDataLength = data.length;
                fullData = data;
                console.log('fullData initialized with', fullData.length, 'readings');
                
                const stats = calculateStats(data);
                
                document.getElementById('loadingContainer').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                renderDashboard(data, stats);

                // Time selector buttons
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        console.log('Switching to granularity:', btn.dataset.granularity);
                        console.log('fullData.length at click time:', fullData.length);
                        
                        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        currentGranularity = btn.dataset.granularity;
                        
                        console.log('Recalculating stats for', currentGranularity, 'with', fullData.length, 'data points');
                        const newStats = calculateStats(fullData);
                        console.log('New time series has', newStats.timeSeriesData.labels.length, 'points');
                        console.log('Time series labels:', newStats.timeSeriesData.labels.slice(0, 5));
                        console.log('Time series values:', newStats.timeSeriesData.values.slice(0, 5));
                        
                        updateStatsCards(newStats);
                        updateCharts(newStats);
                    });
                });

                setTimeout(() => {
                    document.getElementById('updateIndicator').classList.add('visible');
                }, 1000);

                setInterval(updateDashboard, 60000);
                
                console.log('Dashboard initialized. Real-time updates enabled (60s interval).');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError(error.message || 'Failed to fetch stress data. Please check your connection and try again.');
            }
        }

        init();
    </script>
</body>
</html>